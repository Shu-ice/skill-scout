import React, { useState, useEffect, useCallback, useRef } from 'react';
import { View, Text, Pressable, StyleSheet, Animated, Dimensions, Platform, StatusBar, ScrollView } from 'react-native';
import { LinearGradient } from 'expo-linear-gradient';
import AsyncStorage from '@react-native-async-storage/async-storage';
import * as Haptics from 'expo-haptics';

// Ëâ≤„ÅÆÂÆöÁæ©ÔºàÂπ¥Èï∑ÔΩû‰ΩéÂ≠¶Âπ¥Âêë„Åë„Å´Ë¶ã„ÇÑ„Åô„ÅÑËâ≤ÂΩ©Ôºâ
const COLORS = [
  { name: '„ÅÇ„Åã', code: '#D32F2F', gradient: ['#D32F2F', '#F44336'], displayName: '„ÅÇ„Åã' },
  { name: '„ÅÇ„Åä', code: '#2196F3', gradient: ['#2196F3', '#42A5F5'], displayName: '„ÅÇ„Åä' },
  { name: '„Åø„Å©„Çä', code: '#4CAF50', gradient: ['#4CAF50', '#66BB6A'], displayName: '„Åø„Å©„Çä' },
  { name: '„Åç„ÅÑ„Çç', code: '#FFD600', gradient: ['#FFD600', '#FFEB3B'], displayName: '„Åç„ÅÑ„Çç' },
  { name: '„Éî„É≥„ÇØ', code: '#FF69B4', gradient: ['#FF69B4', '#FFB6C1'], displayName: '„Éî„É≥„ÇØ' },
  { name: '„Åè„Çç', code: '#424242', gradient: ['#424242', '#616161'], displayName: '„Åè„Çç' },
];

// „É¨„Éô„É´Ë®≠ÂÆö
const LEVEL_CONFIG = {
  1: { 
    colors: 3, 
    problems: 10, 
    title: '„ÇÑ„Åï„Åó„ÅÑ', 
    description: '3„Å§„ÅÆ„ÅÑ„Çç„Åã„Çâ „Åà„Çâ„Åº„ÅÜÔºÅ',
    emoji: 'üåü'
  },
  2: { 
    colors: 4, 
    problems: 15, 
    title: '„Åµ„Å§„ÅÜ', 
    description: '4„Å§„ÅÆ„ÅÑ„Çç„Åß „Åå„Çì„Å∞„Çç„ÅÜÔºÅ',
    emoji: 'üöÄ'
  },
  3: { 
    colors: 5, 
    problems: 20, 
    title: '„ÇÄ„Åö„Åã„Åó„ÅÑ', 
    description: '5„Å§„ÅÆ„ÅÑ„Çç„Åß „Åô„Åî„ÅÑ„Å≠ÔºÅ',
    emoji: 'üèÜ'
  },
  4: { 
    colors: 6, 
    problems: 25, 
    title: '„Ç®„Ç≠„Çπ„Éë„Éº„Éà', 
    description: '6„Å§„ÅÆ„ÅÑ„Çç„Åß „Å†„ÅÑ„Åô„ÅçÔºÅ',
    emoji: 'üéØ'
  },
};

interface GameRecord {
  date: string;
  level: number;
  score: number;
  total: number;
  accuracy: number;
  duration: number; // ÊâÄË¶ÅÊôÇÈñìÔºàÁßíÔºâ
  gameId: string;
  gameType: 'stroop';
}

interface StroopGameProps {
  onGameEnd: () => void;
}

type GameState = 'welcome' | 'levelSelect' | 'countdown' | 'playing' | 'result';

const { width: screenWidth, height: screenHeight } = Dimensions.get('window');

export default function StroopGame({ onGameEnd }: StroopGameProps) {
  const [gameState, setGameState] = useState<GameState>('welcome');
  const [selectedLevel, setSelectedLevel] = useState(1);
  const [score, setScore] = useState(0);
  const [totalProblems, setTotalProblems] = useState(0);
  const [currentProblem, setCurrentProblem] = useState(0);
  const [startTime, setStartTime] = useState(0);
  const [duration, setDuration] = useState(0);
  const [activeTab, setActiveTab] = useState<'game' | 'records'>('game');
  const [currentWord, setCurrentWord] = useState(COLORS[0]);
  const [currentColor, setCurrentColor] = useState(COLORS[1]);
  const [combo, setCombo] = useState(0);
  const [maxCombo, setMaxCombo] = useState(0);
  const [showFeedback, setShowFeedback] = useState(false);
  const [lastCorrect, setLastCorrect] = useState(false);
  const [countdownValue, setCountdownValue] = useState(3);
  const [records, setRecords] = useState<GameRecord[]>([]);
  const [soundEnabled, setSoundEnabled] = useState(true);
  
  // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
  const fadeAnim = useRef(new Animated.Value(0)).current;
  const scaleAnim = useRef(new Animated.Value(1)).current;
  const confettiAnim = useRef(new Animated.Value(0)).current;
  const feedbackAnim = useRef(new Animated.Value(0)).current;
  const countdownAnim = useRef(new Animated.Value(0)).current;
  const sparkleAnim = useRef(new Animated.Value(0)).current;
  const rainbowAnim = useRef(new Animated.Value(0)).current;
  
  // „Çø„Ç§„Éû„ÉºÂèÇÁÖß
  const gameTimer = useRef<NodeJS.Timeout | null>(null);

  // „Éá„Éº„Çø„É≠„Éº„Éâ
  useEffect(() => {
    loadRecords();
  }, []);

  const loadRecords = async () => {
    try {
      const recordsStr = await AsyncStorage.getItem('stroopRecords');
      if (recordsStr) {
        setRecords(JSON.parse(recordsStr));
      }
    } catch {
      console.log('Ë®òÈå≤„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  };

  const saveRecord = useCallback(async (record: GameRecord) => {
    try {
      const newRecords = [record, ...records].slice(0, 50);
      setRecords(newRecords);
      await AsyncStorage.setItem('stroopRecords', JSON.stringify(newRecords));
    } catch {
      console.log('Ë®òÈå≤„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  }, [records]);

  // ÂäπÊûúÈü≥„ÅÆÂÜçÁîüÔºà„Éè„Éó„ÉÜ„Ç£„ÉÉ„ÇØÔºâ
  const playSound = useCallback((type: 'correct' | 'incorrect' | 'countdown' | 'start' | 'levelUp') => {
    if (!soundEnabled || Platform.OS === 'web') return;
    
    try {
      switch (type) {
        case 'correct':
          Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
          break;
        case 'incorrect':
          Haptics.notificationAsync(Haptics.NotificationFeedbackType.Warning);
          break;
        case 'levelUp':
          Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Heavy);
          break;
        case 'countdown':
        case 'start':
          Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
          break;
      }
    } catch {
      console.log('„Éè„Éó„ÉÜ„Ç£„ÉÉ„ÇØ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Ç®„É©„Éº');
    }
  }, [soundEnabled]);

  // ÊôÇÈñìË®àÊ∏¨„ÅÆÂá¶ÁêÜ
  useEffect(() => {
    if (gameState === 'playing' && startTime > 0) {
      const timerId = setInterval(() => {
        setDuration(Math.floor((Date.now() - startTime) / 1000));
      }, 1000);

      return () => clearInterval(timerId);
    }
  }, [gameState, startTime]);

  // „Ç≤„Éº„É†ÁµÇ‰∫ÜÂà§ÂÆö
  useEffect(() => {
    if (gameState === 'playing' && currentProblem >= LEVEL_CONFIG[selectedLevel].problems) {
      endGame();
    }
  }, [currentProblem, selectedLevel, gameState]);

  // Êñ∞„Åó„ÅÑÂïèÈ°å„ÅÆÁîüÊàê
  const generateNewTrial = useCallback(() => {
    const levelColors = COLORS.slice(0, LEVEL_CONFIG[selectedLevel].colors);
    let newWordIndex = Math.floor(Math.random() * levelColors.length);
    let newColorIndex = Math.floor(Math.random() * levelColors.length);

    // „É¨„Éô„É´„Å´„Çà„Å£„Å¶„Çπ„Éà„É´„Éº„ÉóË™≤È°å„ÅÆÈõ£ÊòìÂ∫¶„ÇíË™øÊï¥
    const matchRate = selectedLevel === 1 ? 0.4 : selectedLevel === 2 ? 0.3 : 0.2;
    
    if (Math.random() > matchRate) {
      while (newColorIndex === newWordIndex) {
        newColorIndex = Math.floor(Math.random() * levelColors.length);
      }
    }

    setCurrentWord(levelColors[newWordIndex]);
    setCurrentColor(levelColors[newColorIndex]);
    
    // „ÉØ„Éº„Éâ„ÅÆÁôªÂ†¥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
    Animated.sequence([
      Animated.timing(scaleAnim, {
        toValue: 1.2,
        duration: 200,
        useNativeDriver: true,
      }),
      Animated.timing(scaleAnim, {
        toValue: 1,
        duration: 200,
        useNativeDriver: true,
      }),
    ]).start();
  }, [selectedLevel, scaleAnim]);

  // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÈñãÂßã
  const startCountdown = useCallback(() => {
    setGameState('countdown');
    setCountdownValue(3);
    
    const countdown = (value: number) => {
      setCountdownValue(value);
      playSound('countdown');
      
      Animated.sequence([
        Animated.timing(countdownAnim, {
          toValue: 1,
          duration: 300,
          useNativeDriver: true,
        }),
        Animated.timing(countdownAnim, {
          toValue: 0,
          duration: 700,
          useNativeDriver: true,
        }),
      ]).start(() => {
        if (value > 1) {
          countdown(value - 1);
        } else {
          setCountdownValue(0);
          playSound('start');
          Animated.timing(countdownAnim, {
            toValue: 1,
            duration: 500,
            useNativeDriver: true,
          }).start(() => {
            setTimeout(() => {
              Animated.timing(countdownAnim, {
                toValue: 0,
                duration: 200,
                useNativeDriver: true,
              }).start(() => {
                setGameState('playing');
                generateNewTrial();
              });
            }, 400);
          });
        }
      });
    };
    
    countdown(3);
  }, [countdownAnim, playSound, generateNewTrial]);

  // „Ç≤„Éº„É†ÈñãÂßãÂá¶ÁêÜ
  const startGame = useCallback((level: number) => {
    setSelectedLevel(level);
    setScore(0);
    setCurrentProblem(0);
    setCombo(0);
    setTotalProblems(LEVEL_CONFIG[level].problems);
    setStartTime(Date.now());
    setDuration(0);
    
    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É™„Çª„ÉÉ„Éà
    fadeAnim.setValue(0);
    scaleAnim.setValue(1);
    confettiAnim.setValue(0);
    feedbackAnim.setValue(0);
    sparkleAnim.setValue(0);
    rainbowAnim.setValue(0);
    
    startCountdown();
  }, [fadeAnim, scaleAnim, confettiAnim, feedbackAnim, sparkleAnim, rainbowAnim, startCountdown]);

  // „Ç≤„Éº„É†ÁµÇ‰∫ÜÂá¶ÁêÜ
  const endGame = useCallback(() => {
    if (gameTimer.current) {
      clearTimeout(gameTimer.current);
    }

    const finalDuration = startTime > 0 ? Math.floor((Date.now() - startTime) / 1000) : duration;
    const accuracy = totalProblems > 0 ? Math.round((score / totalProblems) * 100) : 0;
    
    // Ë®òÈå≤‰øùÂ≠ò
    const record: GameRecord = {
      date: new Date().toLocaleString('ja-JP'),
      level: selectedLevel,
      score,
      total: totalProblems,
      accuracy,
      duration: finalDuration,
      gameId: Date.now().toString(),
      gameType: 'stroop',
    };
    saveRecord(record);

    if (combo > maxCombo) setMaxCombo(combo);
    setDuration(finalDuration);
    setGameState('result');
  }, [score, totalProblems, selectedLevel, combo, maxCombo, startTime, duration, saveRecord]);

  // Ê≠£Ëß£„Éª‰∏çÊ≠£Ëß£„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
  const showFeedbackAnimation = useCallback((isCorrect: boolean) => {
    setShowFeedback(true);
    setLastCorrect(isCorrect);
    
    if (isCorrect) {
      // Ê≠£Ëß£ÊôÇ„ÅÆË±™ËèØ„Å™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
      Animated.parallel([
        // Á¥ôÂêπÈõ™
        Animated.sequence([
          Animated.timing(confettiAnim, {
            toValue: 1,
            duration: 300,
            useNativeDriver: true,
          }),
          Animated.timing(confettiAnim, {
            toValue: 0,
            duration: 1500,
            useNativeDriver: true,
          }),
        ]),
        // Ëôπ„Ç®„Éï„Çß„ÇØ„Éà
        Animated.sequence([
          Animated.timing(rainbowAnim, {
            toValue: 1,
            duration: 400,
            useNativeDriver: true,
          }),
          Animated.timing(rainbowAnim, {
            toValue: 0,
            duration: 1100,
            useNativeDriver: true,
          }),
        ]),
        // „Ç≠„É©„Ç≠„É©
        Animated.loop(
          Animated.sequence([
            Animated.timing(sparkleAnim, {
              toValue: 1,
              duration: 200,
              useNativeDriver: true,
            }),
            Animated.timing(sparkleAnim, {
              toValue: 0,
              duration: 200,
              useNativeDriver: true,
            }),
          ]),
          { iterations: 3 }
        ),
      ]).start();
    } else {
      // ‰∏çÊ≠£Ëß£ÊôÇ„ÅÆÂÑ™„Åó„ÅÑ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
      Animated.sequence([
        Animated.timing(feedbackAnim, {
          toValue: 1,
          duration: 300,
          useNativeDriver: true,
        }),
        Animated.timing(feedbackAnim, {
          toValue: 0,
          duration: 800,
          useNativeDriver: true,
        }),
      ]).start();
    }
    
    setTimeout(() => {
      setShowFeedback(false);
    }, 1200); // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÊó©„ÇÅ„Å´„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
  }, [confettiAnim, rainbowAnim, sparkleAnim, feedbackAnim]);

  // ÂõûÁ≠îÂá¶ÁêÜ
  const handleAnswer = useCallback((selectedColorName: string) => {
    if (gameState !== 'playing') return;

    const isCorrect = selectedColorName === currentColor.name;
    
    if (isCorrect) {
      setScore(prev => prev + 1);
      setCombo(prev => {
        const newCombo = prev + 1;
        if (newCombo > maxCombo) setMaxCombo(newCombo);
        return newCombo;
      });
      playSound('correct');
    } else {
      setCombo(0);
      playSound('incorrect');
    }
    
    setCurrentProblem(prev => prev + 1);
    showFeedbackAnimation(isCorrect);
    
    // Ê¨°„ÅÆÂïèÈ°å„Å∏Ôºà„ÉÜ„É≥„ÉùÊîπÂñÑÔºö„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫„Å®ÂêåÊôÇ„Å´Ê¨°„ÅÆÂïèÈ°åÊ∫ñÂÇôÔºâ
    setTimeout(() => {
      if (currentProblem + 1 >= LEVEL_CONFIG[selectedLevel].problems) {
        endGame();
      } else {
        generateNewTrial();
      }
    }, 800); // Áü≠Á∏Æ„Åó„Å¶„ÉÜ„É≥„Éù„Ç¢„ÉÉ„Éó
  }, [gameState, currentColor.name, currentProblem, selectedLevel, maxCombo, playSound, showFeedbackAnimation, endGame, generateNewTrial]);

  // „Ç¶„Çß„É´„Ç´„É†ÁîªÈù¢
  const renderWelcome = () => (
    <View style={styles.welcomeContainer}>
      <Text style={styles.welcomeTitle}>üåà „Å´„Åò„ÅÑ„Çç„Ç≥„Éà„Éê üåà</Text>
      <Text style={styles.welcomeSubtitle}>„ÇÇ„Åò„ÅÆ„ÅÑ„Çç„Çí „ÅÇ„Å¶„Çã„Ç≤„Éº„É†ÔºÅ</Text>
      <View style={styles.instructionContainer}>
        <Text style={styles.instructionHighlight}>‚ö†Ô∏è „Å†„ÅÑ„Åò„Å™„É´„Éº„É´ ‚ö†Ô∏è</Text>
        <Text style={styles.welcomeDescription}>
          <Text style={styles.emphasisText}>„Åì„Å®„Å∞„Åß„ÅØ„Å™„Åè</Text>
          {"\n"}
          <Text style={styles.emphasisText}>„ÇÇ„Åò„ÅÆ„ÅÑ„Çç„Çí„Åø„Å¶</Text>
          {"\n"}
          <Text style={styles.emphasisText}>„Åü„Å†„Åó„ÅÑ„ÅÑ„Çç„ÅÆ„Éú„Çø„É≥„Çí„Åä„Åó„Å¶„Å≠ÔºÅ</Text>
        </Text>
        <Text style={styles.exampleText}>
          „Çå„ÅÑÔºö„Äå„ÅÇ„Åã„Äç„Åå „Åø„Å©„Çä„ÅÑ„Çç ‚Üí „Åø„Å©„Çä„Éú„Çø„É≥„Çí„Åä„Åô
        </Text>
      </View>
      
      <Pressable style={styles.welcomeStartButton} onPress={() => setGameState('levelSelect')}>
        <LinearGradient
          colors={['#FF1744', '#2196F3', '#4CAF50', '#FFD600']}
          style={styles.welcomeStartButtonGradient}
          start={{ x: 0, y: 0 }}
          end={{ x: 1, y: 1 }}
        >
          <Text style={styles.welcomeStartButtonText}>üéâ „ÅÇ„Åù„Çì„Åß„Åø„ÇãÔºÅ üéâ</Text>
        </LinearGradient>
      </Pressable>
    </View>
  );

  // „É¨„Éô„É´ÈÅ∏ÊäûÁîªÈù¢
  const renderLevelSelect = () => (
    <ScrollView style={styles.levelSelectContainer} contentContainerStyle={styles.levelSelectContent}>
      <Text style={styles.levelSelectTitle}>üéØ „É¨„Éô„É´„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ üéØ</Text>
      
      <View style={styles.levelGrid}>
        {Object.entries(LEVEL_CONFIG).map(([level, config]) => (
          <Pressable
            key={level}
            style={styles.levelCard}
            onPress={() => startGame(parseInt(level))}
          >
            <LinearGradient
              colors={config.colors <= 3 ? ['#4CAF50', '#66BB6A'] : 
                     config.colors <= 4 ? ['#2196F3', '#42A5F5'] :
                     config.colors <= 5 ? ['#FF6D00', '#FF8A65'] :
                     ['#9C27B0', '#BA68C8']}
              style={styles.levelCardGradient}
            >
              <Text style={styles.levelEmoji}>{config.emoji}</Text>
              <Text style={styles.levelTitle}>{config.title}</Text>
              <Text style={styles.levelDescription}>{config.description}</Text>
              <Text style={styles.levelDetails}>
                {config.colors}„ÅÑ„Çç„Éª{config.problems}„ÇÇ„Çì
              </Text>
            </LinearGradient>
          </Pressable>
        ))}
      </View>
      
      <Pressable style={styles.backToWelcomeButton} onPress={() => setGameState('welcome')}>
        <LinearGradient
          colors={['#FF6B6B', '#ff4757']}
          style={styles.backToWelcomeButtonGradient}
        >
          <Text style={styles.backToWelcomeButtonText}>üîô „ÇÇ„Å©„Çã</Text>
        </LinearGradient>
      </Pressable>
    </ScrollView>
  );

  // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÁîªÈù¢
  const renderCountdown = () => (
    <View style={styles.countdownContainer}>
      <Animated.View
        style={[
          styles.countdownCircle,
          {
            opacity: countdownAnim,
            transform: [{
              scale: countdownAnim.interpolate({
                inputRange: [0, 1],
                outputRange: [0.5, 1.2]
              })
            }]
          }
        ]}
      >
        <LinearGradient
          colors={countdownValue > 0 ? ['#FF6B35', '#F7931E'] : ['#4CAF50', '#66BB6A']}
          style={styles.countdownGradient}
        >
          <Text style={styles.countdownText}>
            {countdownValue > 0 ? countdownValue : '„Çπ„Çø„Éº„Éà!'}
          </Text>
        </LinearGradient>
      </Animated.View>
      
      {countdownValue > 0 && (
        <Text style={styles.countdownSubText}>„Åò„ÇÖ„Çì„Å≥„ÅØ„ÅÑ„ÅÑÔºü</Text>
      )}
    </View>
  );

  // „Ç≤„Éº„É†ÁîªÈù¢
  const renderGame = () => {
    const levelColors = COLORS.slice(0, LEVEL_CONFIG[selectedLevel].colors);
    
    return (
      <View style={styles.gameContainer}>
        {/* „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†± */}
        <View style={styles.gameHeader}>
          <View style={styles.statsRow}>
            <Text style={styles.statsText}>‚≠ê {score}/{totalProblems}</Text>
            <Text style={styles.statsText}>‚è∞ {Math.floor(duration / 60)}:{(duration % 60).toString().padStart(2, '0')}</Text>
            <Text style={styles.statsText}>üî• {combo}</Text>
          </View>
          <View style={styles.progressContainer}>
            <View style={styles.progressBar}>
              <View style={[
                styles.progressFill,
                { width: `${(currentProblem / totalProblems) * 100}%` }
              ]} />
            </View>
          </View>
        </View>

        {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
        <View style={styles.gameContent}>
          {/* ÂçòË™ûË°®Á§∫ */}
          <View style={styles.wordContainer}>
            <Animated.Text 
              style={[
                styles.wordText, 
                { 
                  color: currentColor.code,
                  transform: [{ scale: scaleAnim }]
                }
              ]}
            >
              {currentWord.displayName || currentWord.name}
            </Animated.Text>
          </View>

          {/* Ëâ≤ÈÅ∏Êäû„Éú„Çø„É≥ */}
          <View style={styles.colorButtonsContainer}>
            {levelColors.map((color, index) => (
              <Pressable
                key={color.name}
                style={styles.colorButton}
                onPress={() => handleAnswer(color.name)}
              >
                <LinearGradient
                  colors={color.gradient}
                  style={styles.colorButtonGradient}
                >
                  <Text style={styles.colorButtonText}>{color.name}</Text>
                  <View style={[styles.colorIndicator, { backgroundColor: color.code }]} />
                </LinearGradient>
              </Pressable>
            ))}
          </View>
        </View>

        {/* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫Ôºà„Ç™„Éº„Éê„Éº„É¨„Ç§„ÅßÊ¨°„ÅÆÂïèÈ°å„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Å™„ÅÑÔºâ */}
        {showFeedback && (
          <View style={styles.feedbackOverlay}>
            {lastCorrect ? (
              <>
                {/* Ê≠£Ëß£ÊôÇ„ÅÆÁ¥ôÂêπÈõ™ */}
                <Animated.View
                  style={[
                    styles.confettiContainer,
                    {
                      opacity: confettiAnim,
                      transform: [{
                        translateY: confettiAnim.interpolate({
                          inputRange: [0, 1],
                          outputRange: [0, -200]
                        })
                      }]
                    }
                  ]}
                >
                  {Array.from({ length: 12 }, (_, i) => (
                    <Text key={i} style={[
                      styles.confetti,
                      { 
                        left: `${(i * 8) + 10}%`,
                        animationDelay: `${i * 50}ms`
                      }
                    ]}>
                      {['üéâ', 'üéä', '‚ú®', 'üåü', 'üí´', 'üéà', 'üéÅ', 'üèÜ', 'üåà', '‚≠ê', 'üíñ', 'ü¶Ñ'][i]}
                    </Text>
                  ))}
                </Animated.View>
                
                {/* Ëôπ„Ç®„Éï„Çß„ÇØ„Éà */}
                <Animated.View
                  style={[
                    styles.rainbowContainer,
                    {
                      opacity: rainbowAnim,
                      transform: [{
                        scale: rainbowAnim.interpolate({
                          inputRange: [0, 1],
                          outputRange: [0.8, 1.2]
                        })
                      }]
                    }
                  ]}
                >
                  <Text style={styles.rainbowText}>üåà „Åô„Åî„ÅÑÔºÅ üåà</Text>
                </Animated.View>
                
                {/* „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà */}
                <Animated.View
                  style={[
                    styles.sparkleContainer,
                    {
                      opacity: sparkleAnim,
                      transform: [{
                        rotate: sparkleAnim.interpolate({
                          inputRange: [0, 1],
                          outputRange: ['0deg', '360deg']
                        })
                      }]
                    }
                  ]}
                >
                  {Array.from({ length: 8 }, (_, i) => (
                    <Text key={i} style={[
                      styles.sparkle,
                      { 
                        transform: [{
                          rotate: `${i * 45}deg`
                        }]
                      }
                    ]}>‚ú®</Text>
                  ))}
                </Animated.View>
              </>
            ) : (
              <Animated.View
                style={[
                  styles.incorrectFeedback,
                  {
                    opacity: feedbackAnim,
                    transform: [{
                      scale: feedbackAnim.interpolate({
                        inputRange: [0, 1],
                        outputRange: [0.8, 1]
                      })
                    }]
                  }
                ]}
              >
                <Text style={styles.incorrectText}>ü§ó „Å†„ÅÑ„Åò„Çá„ÅÜ„Å∂ÔºÅ ü§ó</Text>
                <Text style={styles.encouragementText}>„Å§„Åé „Åå„Çì„Å∞„Çç„ÅÜÔºÅ</Text>
              </Animated.View>
            )}
          </View>
        )}
      </View>
    );
  };

  // Ë®òÈå≤ÁîªÈù¢
  const renderRecords = () => (
    <View style={styles.recordsContainer}>
      <Text style={styles.sectionTitle}>üìä „Ç≤„Éº„É†„Åç„Çç„Åè</Text>
      {records.length === 0 ? (
        <View style={styles.emptyContainer}>
          <Text style={styles.emptyText}>„Åæ„Å†„Åç„Çç„Åè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</Text>
          <Text style={styles.emptySubText}>„Ç≤„Éº„É†„Çí„Åó„Å¶„Åç„Çç„Åè„Çí„Å§„Åè„Çç„ÅÜÔºÅ</Text>
        </View>
      ) : (
        <ScrollView style={styles.recordsList}>
          {records.slice(0, 10).map((record, index) => (
            <View key={index} style={styles.recordItem}>
              <View style={styles.recordHeader}>
                <Text style={styles.recordDate}>{record.date}</Text>
                <Text style={[
                  styles.recordResult,
                  { color: record.accuracy >= 80 ? '#4CAF50' : record.accuracy >= 60 ? '#FF9800' : '#f44336' }
                ]}>
                  {record.accuracy >= 80 ? 'üåü „Åô„Å∞„Çâ„Åó„ÅÑ' : record.accuracy >= 60 ? 'üòä „Åå„Çì„Å∞„Å£„Åü' : 'üí™ „Çå„Çì„Åó„ÇÖ„ÅÜ'}
                </Text>
              </View>
              <Text style={styles.recordDetails}>
                „É¨„Éô„É´: {LEVEL_CONFIG[record.level]?.title || record.level} | 
                „Åõ„ÅÑ„Åã„ÅÑ: {record.score}/{record.total} ({record.accuracy}%)
              </Text>
              <Text style={styles.recordTime}>
                „Åò„Åã„Çì: {Math.floor(record.duration / 60)}„Åµ„Çì {record.duration % 60}„Å≥„Çá„ÅÜ
              </Text>
            </View>
          ))}
        </ScrollView>
      )}
    </View>
  );

  // ÁµêÊûúÁîªÈù¢
  const renderResult = () => {
    const accuracy = totalProblems > 0 ? Math.round((score / totalProblems) * 100) : 0;
    const isExcellent = accuracy >= 80;
    
    return (
      <View style={styles.resultContainer}>
        {/* ÊúÄÁµÇÁ•ùÁ¶è„Ç®„Éï„Çß„ÇØ„Éà */}
        <View style={styles.finalCelebration}>
          {Array.from({ length: 20 }, (_, i) => (
            <Animated.Text
              key={i}
              style={[
                styles.celebrationEmoji,
                {
                  left: `${Math.random() * 100}%`,
                  top: `${Math.random() * 100}%`,
                  opacity: confettiAnim.interpolate({
                    inputRange: [0, 1],
                    outputRange: [0.7, 1],
                  }),
                  transform: [{
                    rotate: confettiAnim.interpolate({
                      inputRange: [0, 1],
                      outputRange: ['0deg', '360deg'],
                    }),
                  }],
                },
              ]}
            >
              {['üéâ', 'üéä', '‚ú®', 'üåü', '‚≠ê', 'üí´', 'üéà', 'üéÅ', 'üèÜ', 'üåà'][Math.floor(Math.random() * 10)]}
            </Animated.Text>
          ))}
        </View>
        
        <Text style={styles.resultTitle}>üéâ „Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ üéâ</Text>
        
        <View style={styles.resultScoreContainer}>
          <LinearGradient
            colors={isExcellent ? ['#FFD700', '#FFA500'] : ['#4CAF50', '#66BB6A']}
            style={styles.resultScoreCard}
          >
            <Text style={styles.resultScore}>
              üåü „Å®„Åè„Å¶„Çì üåü{"\n"}{score}/{totalProblems}
            </Text>
            <Text style={styles.resultPercentage}>
              üí´ „Åõ„ÅÑ„Åã„ÅÑ„Çä„Å§ üí´{"\n"}{accuracy}%
            </Text>
            <Text style={styles.resultDuration}>
              ‚è∞ „Åã„Åã„Å£„Åü„Åò„Åã„Çì ‚è∞{"\n"}{Math.floor(duration / 60)}„Åµ„Çì {duration % 60}„Å≥„Çá„ÅÜ
            </Text>
            {maxCombo > 1 && (
              <Text style={styles.comboText}>
                üî• „Åï„ÅÑ„Åì„ÅÜ„Çå„Çì„Åû„Åè üî•{"\n"}{maxCombo}„ÇÇ„Çì
              </Text>
            )}
            {isExcellent && (
              <Text style={styles.excellentMessage}>
                üèÜ „Åô„Å∞„Çâ„Åó„ÅÑÔºÅ{"\n"}„ÅÑ„Çç„ÅÆ„ÅØ„Çì„Å†„Çì„Åå „Å®„Å¶„ÇÇ„Åò„Çá„ÅÜ„ÅöÔºÅ üèÜ
              </Text>
            )}
          </LinearGradient>
        </View>
        
        <View style={styles.resultButtonsContainer}>
          <Pressable 
            style={styles.resultButton}
            onPress={() => startGame(selectedLevel)}
          >
            <LinearGradient
              colors={['#4CAF50', '#45a049']}
              style={styles.resultButtonGradient}
            >
              <Text style={styles.resultButtonText}>üîÑ „ÇÇ„ÅÜ„ÅÑ„Å°„Å©</Text>
            </LinearGradient>
          </Pressable>
          
          <Pressable 
            style={styles.resultButton}
            onPress={() => setGameState('levelSelect')}
          >
            <LinearGradient
              colors={['#2196F3', '#1976D2']}
              style={styles.resultButtonGradient}
            >
              <Text style={styles.resultButtonText}>üéØ „É¨„Éô„É´„Åà„Çâ„Å≥</Text>
            </LinearGradient>
          </Pressable>
          
          <Pressable 
            style={styles.resultButton}
            onPress={onGameEnd}
          >
            <LinearGradient
              colors={['#FF6B35', '#F7931E']}
              style={styles.resultButtonGradient}
            >
              <Text style={styles.resultButtonText}>üè† „Éõ„Éº„É†</Text>
            </LinearGradient>
          </Pressable>
        </View>
      </View>
    );
  };

  // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
  useEffect(() => {
    return () => {
      if (gameTimer.current) {
        clearTimeout(gameTimer.current);
      }
    };
  }, []);

  return (
    <View style={styles.container}>
      {/* Áæé„Åó„ÅÑËÉåÊôØ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */}
      <LinearGradient
        colors={['#FF69B4', '#FFB6C1', '#87CEEB', '#98FB98', '#DDA0DD', '#F0E68C']}
        style={styles.backgroundGradient}
        start={{ x: 0, y: 0 }}
        end={{ x: 1, y: 1 }}
      />
      
      {/* „Ç≠„É©„Ç≠„É©ËÉåÊôØ */}
      <View style={styles.sparkleBackground}>
        {Array.from({ length: 15 }, (_, i) => (
          <Text
            key={i}
            style={[
              styles.backgroundStar,
              {
                left: `${Math.random() * 100}%`,
                top: `${Math.random() * 100}%`,
                animationDelay: `${Math.random() * 3}s`
              }
            ]}
          >
            {['‚≠ê', '‚ú®', 'üåü', 'üí´', 'üåà'][Math.floor(Math.random() * 5)]}
          </Text>
        ))}
      </View>
      
      {/* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */}
      {(gameState === 'welcome' || gameState === 'levelSelect') && (
        <View style={styles.tabContainer}>
          {[
            { key: 'game', label: '„Ç≤„Éº„É†', icon: 'üéÆ' },
            { key: 'records', label: '„Åç„Çç„Åè', icon: 'üìä' },
          ].map(tab => (
            <Pressable
              key={tab.key}
              style={[
                styles.tab,
                { backgroundColor: activeTab === tab.key ? 'rgba(33, 150, 243, 0.9)' : 'rgba(255, 255, 255, 0.7)' }
              ]}
              onPress={() => setActiveTab(tab.key as any)}
            >
              <Text style={styles.tabIcon}>{tab.icon}</Text>
              <Text style={[
                styles.tabText,
                { color: activeTab === tab.key ? 'white' : '#666' }
              ]}>
                {tab.label}
              </Text>
            </Pressable>
          ))}
        </View>
      )}

      {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
      <View style={styles.content}>
        {gameState === 'welcome' && activeTab === 'game' && renderWelcome()}
        {gameState === 'welcome' && activeTab === 'records' && renderRecords()}
        {gameState === 'levelSelect' && activeTab === 'game' && renderLevelSelect()}
        {gameState === 'levelSelect' && activeTab === 'records' && renderRecords()}
        {gameState === 'countdown' && renderCountdown()}
        {gameState === 'playing' && renderGame()}
        {gameState === 'result' && renderResult()}
      </View>
      
      {/* „Çµ„Ç¶„É≥„ÉâË®≠ÂÆö„Éú„Çø„É≥ */}
      <Pressable 
        style={styles.soundToggle}
        onPress={() => setSoundEnabled(!soundEnabled)}
      >
        <Text style={styles.soundToggleText}>
          {soundEnabled ? 'üîä' : 'üîá'}
        </Text>
      </Pressable>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  backgroundGradient: {
    position: 'absolute',
    left: 0,
    right: 0,
    top: 0,
    bottom: 0,
  },
  sparkleBackground: {
    position: 'absolute',
    left: 0,
    right: 0,
    top: 0,
    bottom: 0,
    zIndex: 1,
  },
  backgroundStar: {
    position: 'absolute',
    fontSize: 20,
    opacity: 0.6,
  },
  content: {
    flex: 1,
    paddingTop: Platform.OS === 'ios' ? 50 : StatusBar.currentHeight ? StatusBar.currentHeight + 15 : 40,
    paddingHorizontal: 15,
    paddingBottom: 15,
    zIndex: 2,
  },
  soundToggle: {
    position: 'absolute',
    top: Platform.OS === 'ios' ? 50 : StatusBar.currentHeight ? StatusBar.currentHeight + 15 : 40,
    right: 20,
    backgroundColor: 'rgba(255, 255, 255, 0.8)',
    borderRadius: 25,
    width: 50,
    height: 50,
    justifyContent: 'center',
    alignItems: 'center',
    zIndex: 3,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
    elevation: 5,
  },
  soundToggleText: {
    fontSize: 24,
  },
  
  // „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
  tabContainer: {
    flexDirection: 'row',
    paddingTop: Platform.OS === 'ios' ? 10 : 10,
    paddingBottom: 8,
    paddingHorizontal: 10,
    justifyContent: 'space-around',
    zIndex: 2,
    backgroundColor: 'rgba(255, 255, 255, 0.1)',
  },
  tab: {
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 15,
    alignItems: 'center',
    minWidth: 70,
    marginHorizontal: 3,
    justifyContent: 'center',
  },
  tabIcon: {
    fontSize: 18,
    marginBottom: 2,
  },
  tabText: {
    fontSize: 12,
    fontWeight: 'bold',
  },
  
  // „Ç¶„Çß„É´„Ç´„É†ÁîªÈù¢
  welcomeContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingHorizontal: 20,
  },
  welcomeTitle: {
    fontSize: screenWidth < 400 ? 28 : 32,
    fontWeight: 'bold',
    color: '#FF1493',
    marginBottom: 15,
    textAlign: 'center',
    textShadowColor: '#FFD700',
    textShadowOffset: { width: 2, height: 2 },
    textShadowRadius: 3,
    lineHeight: screenWidth < 400 ? 34 : 38,
    paddingHorizontal: 10,
  },
  welcomeSubtitle: {
    fontSize: 18,
    color: '#555',
    marginBottom: 20,
    textAlign: 'center',
    fontWeight: '600',
  },
  instructionContainer: {
    backgroundColor: 'rgba(255, 255, 255, 0.95)',
    borderRadius: 20,
    padding: 20,
    marginBottom: 30,
    marginHorizontal: 10,
    borderWidth: 3,
    borderColor: '#FFD700',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.2,
    shadowRadius: 8,
    elevation: 8,
  },
  instructionHighlight: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#FF4500',
    textAlign: 'center',
    marginBottom: 15,
    textShadowColor: '#FFD700',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
  },
  welcomeDescription: {
    fontSize: 16,
    color: '#333',
    textAlign: 'center',
    lineHeight: 24,
    marginBottom: 15,
  },
  emphasisText: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#FF1744',
  },
  exampleText: {
    fontSize: 14,
    color: '#666',
    textAlign: 'center',
    fontStyle: 'italic',
    backgroundColor: 'rgba(255, 235, 59, 0.2)',
    padding: 10,
    borderRadius: 10,
    borderLeftWidth: 4,
    borderLeftColor: '#FFD600',
  },
  welcomeStartButton: {
    borderRadius: 30,
    overflow: 'hidden',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.3,
    shadowRadius: 10,
    elevation: 10,
    marginTop: 20,
    width: '85%',
    maxWidth: 320,
  },
  welcomeStartButtonGradient: {
    paddingHorizontal: 40,
    paddingVertical: 18,
    minHeight: 56,
    alignItems: 'center',
    justifyContent: 'center',
  },
  welcomeStartButtonText: {
    color: 'white',
    fontSize: 22,
    fontWeight: 'bold',
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
    textAlign: 'center',
    lineHeight: 28,
    paddingHorizontal: 10,
  },
  
  // „É¨„Éô„É´ÈÅ∏ÊäûÁîªÈù¢
  levelSelectContainer: {
    flex: 1,
  },
  levelSelectContent: {
    flexGrow: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingVertical: 20,
  },
  levelSelectTitle: {
    fontSize: screenWidth < 400 ? 20 : 24,
    fontWeight: 'bold',
    color: '#FF1493',
    marginBottom: 30,
    textAlign: 'center',
    textShadowColor: '#FFD700',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
    lineHeight: screenWidth < 400 ? 26 : 30,
    paddingHorizontal: 10,
  },
  levelGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'center',
    gap: 15,
    marginBottom: 30,
    paddingHorizontal: 10,
  },
  levelCard: {
    width: screenWidth < 400 ? '45%' : '40%',
    minWidth: 150,
    maxWidth: 180,
    borderRadius: 20,
    overflow: 'hidden',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.3,
    shadowRadius: 10,
    elevation: 10,
    marginBottom: 10,
  },
  levelCardGradient: {
    padding: 20,
    alignItems: 'center',
    justifyContent: 'center',
    minHeight: 140,
  },
  levelEmoji: {
    fontSize: 36,
    marginBottom: 8,
  },
  levelTitle: {
    color: 'white',
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 5,
    textAlign: 'center',
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
  },
  levelDescription: {
    color: 'white',
    fontSize: 12,
    textAlign: 'center',
    marginBottom: 8,
    opacity: 0.9,
  },
  levelDetails: {
    color: 'white',
    fontSize: 10,
    textAlign: 'center',
    opacity: 0.8,
  },
  backToWelcomeButton: {
    borderRadius: 25,
    overflow: 'hidden',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 8,
  },
  backToWelcomeButtonGradient: {
    paddingHorizontal: 30,
    paddingVertical: 15,
    alignItems: 'center',
    justifyContent: 'center',
  },
  backToWelcomeButtonText: {
    color: 'white',
    fontSize: 18,
    fontWeight: 'bold',
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
  },
  
  // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÁîªÈù¢
  countdownContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  countdownCircle: {
    width: screenWidth < 400 ? 140 : 180,
    height: screenWidth < 400 ? 140 : 180,
    borderRadius: screenWidth < 400 ? 70 : 90,
    overflow: 'hidden',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 8 },
    shadowOpacity: 0.3,
    shadowRadius: 16,
    elevation: 16,
  },
  countdownGradient: {
    width: '100%',
    height: '100%',
    justifyContent: 'center',
    alignItems: 'center',
  },
  countdownText: {
    fontSize: screenWidth < 400 ? 28 : 32,
    fontWeight: 'bold',
    color: 'white',
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 2, height: 2 },
    textShadowRadius: 4,
    textAlign: 'center',
  },
  countdownSubText: {
    fontSize: 24,
    color: '#FF1493',
    marginTop: 30,
    fontWeight: 'bold',
    textAlign: 'center',
  },
  
  // „Ç≤„Éº„É†ÁîªÈù¢
  gameContainer: {
    flex: 1,
  },
  gameHeader: {
    backgroundColor: 'rgba(255, 255, 255, 0.9)',
    borderRadius: 15,
    padding: 15,
    marginBottom: 20,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.15,
    shadowRadius: 5,
    elevation: 5,
  },
  statsRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 10,
  },
  statsText: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333',
  },
  progressContainer: {
    width: '100%',
  },
  progressBar: {
    height: 8,
    backgroundColor: 'rgba(0, 0, 0, 0.1)',
    borderRadius: 4,
    overflow: 'hidden',
  },
  progressFill: {
    height: '100%',
    backgroundColor: '#4CAF50',
    borderRadius: 4,
  },
  gameContent: {
    flex: 1,
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  wordContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(255, 255, 255, 0.9)',
    borderRadius: 20,
    padding: 30,
    marginVertical: 20,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 8 },
    shadowOpacity: 0.3,
    shadowRadius: 16,
    elevation: 16,
    minHeight: 120,
  },
  wordText: {
    fontSize: Math.min(screenWidth / 5, 80),
    fontWeight: 'bold',
    textShadowColor: 'rgba(0, 0, 0, 0.2)',
    textShadowOffset: { width: 2, height: 2 },
    textShadowRadius: 3,
    textAlign: 'center',
  },
  colorButtonsContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'center',
    gap: 10,
    paddingBottom: 20,
  },
  colorButton: {
    width: screenWidth < 400 ? '45%' : '30%',
    minWidth: 120,
    minHeight: 80,
    borderRadius: 20,
    overflow: 'hidden',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.3,
    shadowRadius: 10,
    elevation: 10,
    marginVertical: 5,
  },
  colorButtonGradient: {
    flex: 1,
    padding: 15,
    alignItems: 'center',
    justifyContent: 'center',
  },
  colorButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: 'bold',
    textShadowColor: 'rgba(0, 0, 0, 0.5)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
    marginBottom: 8,
    textAlign: 'center',
  },
  colorIndicator: {
    width: 30,
    height: 30,
    borderRadius: 15,
    borderWidth: 2,
    borderColor: 'white',
  },
  
  // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÈñ¢ÈÄ£Ôºà„Çø„ÉÉ„Éó„ÇíÈÄö„Åó„Å¶ÈÄ£Á∂ö„Éó„É¨„Ç§ÂèØËÉΩÔºâ
  feedbackOverlay: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    justifyContent: 'center',
    alignItems: 'center',
    zIndex: 10,
    pointerEvents: 'none', // „Çø„ÉÉ„Éó„Çí‰∏ã„ÅÆË¶ÅÁ¥†„Å´ÈÄö„Åô
  },
  confettiContainer: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    height: 200,
    justifyContent: 'flex-start',
    alignItems: 'center',
  },
  confetti: {
    position: 'absolute',
    fontSize: 30,
    top: 0,
  },
  rainbowContainer: {
    backgroundColor: 'rgba(255, 255, 255, 0.95)',
    borderRadius: 25,
    padding: 20,
    borderWidth: 3,
    borderColor: '#FFD700',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 8 },
    shadowOpacity: 0.3,
    shadowRadius: 16,
    elevation: 16,
  },
  rainbowText: {
    fontSize: 32,
    fontWeight: 'bold',
    color: '#FF1493',
    textShadowColor: '#FFD700',
    textShadowOffset: { width: 2, height: 2 },
    textShadowRadius: 3,
    textAlign: 'center',
  },
  sparkleContainer: {
    position: 'absolute',
    width: 120,
    height: 120,
    justifyContent: 'center',
    alignItems: 'center',
  },
  sparkle: {
    position: 'absolute',
    fontSize: 24,
    color: '#FFD700',
  },
  incorrectFeedback: {
    backgroundColor: 'rgba(255, 107, 107, 0.95)',
    borderRadius: 25,
    padding: 20,
    borderWidth: 3,
    borderColor: '#FF6B6B',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 8 },
    shadowOpacity: 0.3,
    shadowRadius: 16,
    elevation: 16,
    alignItems: 'center',
  },
  incorrectText: {
    fontSize: 28,
    fontWeight: 'bold',
    color: 'white',
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
    textAlign: 'center',
    marginBottom: 5,
  },
  encouragementText: {
    fontSize: 18,
    color: 'white',
    textAlign: 'center',
    fontWeight: '600',
  },
  
  // ÁµêÊûúÁîªÈù¢
  resultContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    position: 'relative',
  },
  finalCelebration: {
    position: 'absolute',
    left: 0,
    right: 0,
    top: 0,
    bottom: 0,
    zIndex: 0,
  },
  celebrationEmoji: {
    position: 'absolute',
    fontSize: 28,
    color: '#FFD700',
  },
  resultTitle: {
    fontSize: screenWidth < 400 ? 28 : 32,
    fontWeight: 'bold',
    color: '#FF1493',
    marginBottom: 30,
    textShadowColor: '#FFD700',
    textShadowOffset: { width: 2, height: 2 },
    textShadowRadius: 3,
    textAlign: 'center',
    lineHeight: screenWidth < 400 ? 34 : 38,
    paddingHorizontal: 10,
    zIndex: 1,
  },
  resultScoreContainer: {
    alignItems: 'center',
    marginBottom: 40,
    zIndex: 1,
  },
  resultScoreCard: {
    padding: 30,
    borderRadius: 25,
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 8 },
    shadowOpacity: 0.3,
    shadowRadius: 16,
    elevation: 16,
    minWidth: 280,
  },
  resultScore: {
    fontSize: 22,
    color: 'white',
    fontWeight: 'bold',
    marginBottom: 15,
    textAlign: 'center',
    lineHeight: 28,
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
  },
  resultPercentage: {
    fontSize: 20,
    color: 'white',
    fontWeight: 'bold',
    textAlign: 'center',
    lineHeight: 26,
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
    marginBottom: 10,
  },
  comboText: {
    fontSize: 18,
    color: 'white',
    fontWeight: 'bold',
    textAlign: 'center',
    lineHeight: 24,
    marginTop: 10,
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
  },
  excellentMessage: {
    fontSize: 16,
    color: 'white',
    fontWeight: 'bold',
    textAlign: 'center',
    lineHeight: 22,
    marginTop: 15,
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
  },
  resultButtonsContainer: {
    flexDirection: 'column',
    gap: 15,
    alignItems: 'center',
    zIndex: 1,
  },
  resultButton: {
    borderRadius: 25,
    overflow: 'hidden',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 8,
    minWidth: 200,
  },
  resultButtonGradient: {
    paddingHorizontal: 30,
    paddingVertical: 15,
    alignItems: 'center',
    justifyContent: 'center',
  },
  resultButtonText: {
    color: 'white',
    fontSize: 18,
    fontWeight: 'bold',
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
    textAlign: 'center',
  },
  resultDuration: {
    fontSize: 18,
    color: 'white',
    fontWeight: 'bold',
    textAlign: 'center',
    lineHeight: 24,
    marginTop: 10,
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
  },
  
  // Ë®òÈå≤ÁîªÈù¢
  recordsContainer: {
    flex: 1,
  },
  sectionTitle: {
    fontSize: screenWidth < 400 ? 24 : 28,
    fontWeight: 'bold',
    color: '#333',
    marginBottom: 20,
    textAlign: 'center',
    textShadowColor: '#FFD700',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
    lineHeight: screenWidth < 400 ? 30 : 34,
    paddingHorizontal: 10,
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  emptyText: {
    fontSize: 20,
    color: '#666',
    textAlign: 'center',
    marginBottom: 10,
  },
  emptySubText: {
    fontSize: 16,
    color: '#999',
    textAlign: 'center',
  },
  recordsList: {
    flex: 1,
  },
  recordItem: {
    backgroundColor: 'rgba(255, 255, 255, 0.95)',
    padding: 15,
    borderRadius: 15,
    marginBottom: 10,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  recordHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  recordDate: {
    fontSize: 12,
    color: '#666',
    flex: 1,
  },
  recordResult: {
    fontSize: 14,
    fontWeight: 'bold',
  },
  recordDetails: {
    fontSize: 14,
    color: '#333',
    marginBottom: 5,
  },
  recordTime: {
    fontSize: 12,
    color: '#666',
    fontWeight: '600',
  },
});